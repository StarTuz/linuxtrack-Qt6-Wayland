name: Build & Package

on:
  push:
    branches: [ master, main, modernization-* ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        qt_version: [6]

    name: Build (Qt${{ matrix.qt_version }}) & AppImage

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            libmxml-dev libusb-1.0-0-dev zlib1g-dev \
            libv4l-dev liblo-dev libopencv-dev \
            wine-stable wine32 nlohmann-json3-dev \
            wget file gcc-multilib g++-multilib

      - name: Install Qt6 dependencies
        run: |
          sudo apt-get install -y \
            qt6-base-dev qt6-tools-dev qt6-tools-dev-tools \
            libgl1-mesa-dev libglu1-mesa-dev libx11-dev qt6-l10n-tools libxkbcommon-dev

      - name: Download Catch2 for tests
        run: |
          mkdir -p src/tests/catch2
          wget -q https://github.com/catchorg/Catch2/releases/download/v3.4.0/catch_amalgamated.hpp -O src/tests/catch2/catch_amalgamated.hpp
          wget -q https://github.com/catchorg/Catch2/releases/download/v3.4.0/catch_amalgamated.cpp -O src/tests/catch2/catch_amalgamated.cpp

      - name: Build 32-bit Wine Bridge (Pass 1)
        run: |
          sudo apt-get install -y wine32-tools libwine-dev:i386
          mkdir build32
          cd build32
          cmake .. -DCMAKE_BUILD_TYPE=Release -DENABLE_WINE32=ON
          make NPClient32 FreeTrackClient32
          mkdir -p ../dist32
          # Use find to locate and copy shared objects, handling potential subdirectory changes
          find . -name "NPClient.dll.so" -exec cp {} ../dist32/ \;
          find . -name "FreeTrackClient.dll.so" -exec cp {} ../dist32/ \;
          cd ..
          sudo apt-get remove -y wine32-tools libwine-dev:i386
          sudo apt-get autoremove -y

      - name: Build Main System (Pass 2)
        run: |
          sudo apt-get install -y wine64-tools libwine-dev
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr -DENABLE_WINE32=OFF
          make -j$(nproc)

      - name: Generate AppImage
        env:
          BUILD_DIR: "build"
          APP_DIR: "AppDir"
        run: |
          chmod +x packaging/appimage/make_appimage.sh
          # The script creates AppDir, so we run it, then if we needed to inject we would.
          # But it's better if make_appimage.sh handles dist32.
          ./packaging/appimage/make_appimage.sh

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: Linuxtrack-x86_64.AppImage
          path: "*.AppImage"
          if-no-files-found: error

